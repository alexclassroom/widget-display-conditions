!function(a){"use strict";function d(e,t){this.$elem=a(e),this.options=a.extend({},d.defaultOptions,t),this.$submit=this.$elem.find(':input[type="submit"]'),this.fieldItems={},this.isLoaded=!1,this.setSubmit("saved");var o=this;this.$elem.on("click",".wdc-add-condition-group",function(e){var t=o.createConditionGroup(),i=o.createCondition({group:t.data("id")});t.find(".wdc-conditions").append(i),o.$elem.find(".wdc-condition-groups").append(t)}),this.$elem.on("click",".wdc-add-condition",function(e){var t=a(this).closest(".wdc-condition"),i=t.closest(".wdc-condition-group");o.createCondition({group:i.data("id")}).insertAfter(t)}),this.$elem.on("click",".wdc-remove-condition",function(e){var t=a(this).closest(".wdc-condition"),i=t.closest(".wdc-condition-group");t.remove(),0==i.find(".wdc-condition").length&&i.remove()}),this.$elem.on("change",".wdc-param",function(e){var t=a(this).closest(".wdc-condition");o.updateConditionFields(t)}),this.$elem.on("change",".wdc-param, .wdc-operator, .wdc-value",function(e){o.setSubmit("save")}),this.$elem.on("submit","form",function(e){e.preventDefault(),o.setSubmit("saving"),a.post(ajaxurl,a(this).serialize(),function(e){o.setSubmit("saved")})}),this.$elem.on("DOMNodeInserted DOMNodeRemoved",function(e){var t=a(e.target);o.$elem.find(".wdc-condition").length?o.$elem.addClass("wdc-has-conditions"):o.$elem.removeClass("wdc-has-conditions"),o.isLoaded&&(t.is(".wdc-condition-group")||t.is(".wdc-condition"))&&o.setSubmit("save")}),this.preload()}window.wdc=window.wdc||{},d.defaultOptions={widget:"",nonceName:"",nonce:""},d.generateId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},d.populateSelectField=function(n,e){n.empty(),a.each(e,function(e,t){if(void 0!==(t=a.extend({id:"",text:"",selected:!1},t)).children){var i=a("<optgroup></optgroup>");i.attr("label",t.text),d.populateSelectField(i,t.children),n.append(i)}else{var o=a("<option></option>");o.val(t.id).text(t.text).prop("selected",!!t.selected),void 0!==t.html&&o.html(t.html),n.append(o)}})},d.setSelected=function(e,t){e.find("option").filter(function(){return t==a(this).val()}).prop("selected",!0)},d.prototype.createConditionGroup=function(e){return e=a.extend({id:d.generateId()},e),a(wp.template("wdc-condition-group")({id:e.id}))},d.prototype.createCondition=function(e){e=a.extend({id:d.generateId(),param:"",operator:"",value:"",group:""},e);var t=a(wp.template("wdc-condition")({id:e.id,group:e.group}));return d.setSelected(t.find(".wdc-param"),e.param),this.updateConditionFields(t,{operator:e.operator,value:e.value}),t},d.prototype.updateConditionFields=function(e,t){t=a.extend({},t);e.find(".wdc-param");var i=e.find(".wdc-operator"),o=e.find(".wdc-value");i.prop("disabled",!0),o.prop("disabled",!0),this.getConditionFieldItems(e,function(e){e=a.extend({},e),d.populateSelectField(i,e.operator),d.populateSelectField(o,e.value),void 0!==t.operator&&d.setSelected(i,t.operator),void 0!==t.value&&d.setSelected(o,t.value),i.prop("disabled",!1),o.prop("disabled",!1)})},d.prototype.getConditionFieldItems=function(e,t){var i=e.find(".wdc-param").val();if(void 0===this.fieldItems[i]){var o=this,n=this.prepareAjax({action:"wdc_ui_get_condition_field_items",param:i});a.post(ajaxurl,n,function(e){o.fieldItems[i]=a.extend({},e),t(o.fieldItems[i])})}else t(this.fieldItems[i])},d.prototype.preload=function(){var d=this;this.$elem.addClass("wdc-loading");var e=this.prepareAjax({action:"wdc_ui_preload",widget:this.options.widget});a.post(ajaxurl,e,function(e){d.fieldItems=a.extend({},e.fieldItems),a.each(e.conditions,function(o,e){var n=d.createConditionGroup({id:o});a.each(e,function(e,t){var i=d.createCondition({id:e,param:t.param,operator:t.operator,value:t.value,group:o});n.find(".wdc-conditions").append(i)}),d.$elem.find(".wdc-condition-groups").append(n)}),d.$elem.removeClass("wdc-loading"),d.isLoaded=!0})},d.prototype.setSubmit=function(e){switch(void 0===this.$submit.data("save")&&this.$submit.data("save",this.$submit.text()),e){case"save":this.$submit.text(this.$submit.data("save")).prop("disabled",!1).siblings(".spinner").removeClass("is-active");break;case"saved":this.$submit.text(this.$submit.data("saved")).prop("disabled",!0).siblings(".spinner").removeClass("is-active");break;case"saving":this.$submit.text(this.$submit.data("save")).prop("disabled",!0).siblings(".spinner").addClass("is-active")}},d.prototype.prepareAjax=function(e){return e=a.extend({},e),this.options.nonceName&&(e[this.options.nonceName]=this.options.nonce),e},window.wdc.ui=d}(jQuery),function(o){"use strict";o(document.body).on("click",".wdc-open-ui",function(e){var t=o(this),i=wp.template("wdc-ui")({widget:t.data("widget")});o.featherlight(i,{namespace:"wdc-modal",closeOnClick:!1,closeOnEsc:!1,afterContent:function(){new wdc.ui(this.$content,{widget:t.data("widget"),nonceName:t.data("noncename"),nonce:t.data("nonce")})}})})}(jQuery);